<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Abhinaash Driving</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
<style>
    :root { --accent: #00d4ff; --danger: #ff4d4d; --bg: #0b1020; --card: #161b2d; --green: #00ff88; }
    body{ font-family:Poppins,sans-serif; background:var(--bg); color:white; margin:0; padding:20px; }
    .loginBox{ max-width:400px; margin:80px auto; background:#111; padding:25px; border-radius:14px; text-align:center; border:1px solid #333; }
    .panel{ display:none; max-width:1100px; margin:auto; }
    .grid-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; }
    @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }
    .card{ background:var(--card); padding:16px; border-radius:15px; margin-bottom: 20px; border:1px solid #2d3548; position: relative; }
    input, textarea, select { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #444; background:#000; color:#fff; box-sizing: border-box; }
    button{ padding:12px; border:none; border-radius:10px; font-weight:700; cursor:pointer; background:var(--accent); color:#000; width:100%; margin-top:5px; }
    .btn-red { background: var(--danger) !important; color: white !important; }
    .btn-green { background: var(--green) !important; color: #000 !important; }
    .slot-item { 
        display: flex; justify-content: space-between; align-items: center; 
        background: rgba(255,255,255,0.05); padding: 12px; border-radius: 10px; 
        margin-bottom: 10px; border: 1px solid #333;
    }
</style>
</head>
<body>

<div class="loginBox" id="loginBox">
    <h2 style="color:var(--accent)">üõ°Ô∏è Admin Login</h2>
    <input type="password" id="pass" placeholder="Enter password">
    <button onclick="login()">Enter Dashboard</button>
</div>

<div class="panel" id="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìä Control Center</h2>
        <button onclick="clearAllBookings()" class="btn-red" style="width:auto; font-size:12px; padding:8px 15px;">Clear All Bookings</button>
    </div>

    <div class="grid-layout">
        <div>
            <div class="card" style="border-top: 4px solid var(--accent);">
                <h3>‚öôÔ∏è Manage Batches (Time Slots)</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="slotName" placeholder="e.g. Morning 1">
                    <input type="text" id="slotTime" placeholder="e.g. 7-8 AM">
                    <button class="btn-green" style="width: 150px;" onclick="addSlot()">Add Slot</button>
                </div>
                <div id="slotList">
                    </div>
            </div>

            <h3>üìã Active Bookings</h3>
            <div id="list">Loading...</div>
        </div>

        <div>
            <div class="card" style="border-top: 4px solid var(--green);">
                <h3>üìù Manual Booking</h3>
                <input type="text" id="mName" placeholder="Student Name">
                <input type="tel" id="mPhone" placeholder="Phone Number">
                <select id="mSlotSelect"><option value="">Select Batch</option></select>
                <select id="mSeat">
                    <option value="1">Seat 1</option><option value="2">Seat 2</option>
                    <option value="3">Seat 3</option><option value="4">Seat 4</option>
                </select>
                <button class="btn-green" id="manualBtn" onclick="manualBook()">Lock Seat ‚úÖ</button>
            </div>

            <div class="card" style="border-top: 4px solid #f1c40f;">
                <h3>üì¢ Custom Status</h3>
                <textarea id="customReason" placeholder="Type message..." rows="2"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-green" onclick="setStatus(false)">Class ON</button>
                    <button class="btn-red" onclick="setStatus(true)">Class OFF</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, deleteDoc, doc, setDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.login = () => {
    if(document.getElementById("pass").value === "Admin5"){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("panel").style.display="block";
        initSync();
    } else { alert("Wrong Password!"); }
}

function initSync() {
    // 1. Sync Bookings
    onSnapshot(collection(db,"slotBookings"), (snap) => {
        let html = "";
        snap.forEach(d => {
            const data = d.data();
            html += `<div class="card" style="border-left:4px solid var(--accent)">
                <b>üë§ ${data.name}</b> (${data.phone})<br>
                <small>üöó Batch ID: ${data.slotId} | Seat: ${data.seat}</small><br>
                <button onclick="deleteBooking('${d.id}')" style="width:auto; padding:5px 12px; font-size:11px; background:#444; color:#fff; margin-top:8px;">Cancel Booking</button>
            </div>`;
        });
        document.getElementById("list").innerHTML = html || "No active bookings.";
    });

    // 2. Sync Slots (Manage Batches)
    onSnapshot(collection(db,"siteSlots"), (snap) => {
        let listHtml = "";
        let selectHtml = "<option value=''>Select Batch</option>";
        snap.forEach(d => {
            const s = d.data();
            listHtml += `
            <div class="slot-item">
                <div>
                    <strong>${s.name}</strong><br>
                    <small style="color:var(--accent)">${s.time}</small>
                </div>
                <button class="btn-red" style="width:auto; padding:6px 12px; font-size:11px;" onclick="removeSlot('${d.id}')">Remove Batch</button>
            </div>`;
            selectHtml += `<option value="${d.id}">${s.name} (${s.time})</option>`;
        });
        document.getElementById("slotList").innerHTML = listHtml || "<p style='color:#666'>No batches added yet.</p>";
        document.getElementById("mSlotSelect").innerHTML = selectHtml;
    });
}

// Manage Slots: ADD
window.addSlot = async () => {
    const name = document.getElementById("slotName").value.trim();
    const time = document.getElementById("slotTime").value.trim();
    if(!name || !time) return alert("Please fill both Batch Name and Time!");
    
    const id = name.replace(/\s+/g, '_').toUpperCase(); // Create ID from name
    await setDoc(doc(db, "siteSlots", id), { name, time });
    
    document.getElementById("slotName").value = ""; 
    document.getElementById("slotTime").value = "";
}

// Manage Slots: REMOVE
window.removeSlot = async (id) => {
    if(confirm("Are you sure you want to remove this batch? All existing bookings for this batch will stay but no new bookings can be made.")) {
        await deleteDoc(doc(db, "siteSlots", id));
    }
}

// Delete Booking
window.deleteBooking = async (id) => {
    if(confirm("Cancel this booking?")) await deleteDoc(doc(db, "slotBookings", id));
}

// Manual Booking
window.manualBook = async () => {
    const name = document.getElementById("mName").value.trim();
    const phone = document.getElementById("mPhone").value.trim();
    const slotId = document.getElementById("mSlotSelect").value;
    const seat = document.getElementById("mSeat").value;
    
    if(!name || !slotId) return alert("Enter Student Name and Select Batch!");

    await setDoc(doc(db, "slotBookings", `${slotId}_${seat}`), {
        name, phone, slotId, seat: parseInt(seat), visitorId: "ADMIN_ENTRY", bookedAt: serverTimestamp()
    });
    alert("Manual Booking Done!");
    document.getElementById("mName").value = "";
    document.getElementById("mPhone").value = "";
}

window.clearAllBookings = async () => {
    if(!confirm("‚ö†Ô∏è This will delete ALL student bookings. Proceed?")) return;
    const snap = await getDocs(collection(db, "slotBookings"));
    snap.forEach(d => deleteDoc(d.ref));
    alert("All bookings cleared!");
}

window.setStatus = async (isOff) => {
    const reason = document.getElementById("customReason").value;
    await setDoc(doc(db,"siteControl","classStatus"), { isOff, reason: isOff ? reason : "" });
    alert("Website Status Updated!");
}
</script>
</body>
</html>
