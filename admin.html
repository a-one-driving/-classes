<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Admin | Master Control</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #d4af37; --bg: #000; --card: #121212; --border: #2a2a2a; --txt: #fff; --danger: #ff4d4d; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: var(--txt); padding: 15px; padding-bottom: 50px; }
    .header { border-bottom: 1px solid var(--gold); padding-bottom: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    .section { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 18px; margin-bottom: 25px; }
    h2 { color: var(--gold); margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; gap: 8px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    input, select { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 10px; outline: none; margin-bottom: 5px; }
    .btn { padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 800; border: none; transition: 0.3s; width: 100%; }
    .btn-gold { background: var(--gold); color: #000; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); }
    th { color: var(--gold); }
    .batch-card { background: #000; padding: 12px; border-radius: 12px; border: 1px solid var(--border); }
  </style>
</head>
<body>

<div class="header">
    <h1>A1 <span style="font-weight:300; color:var(--gold);">ADMIN</span></h1>
    <div id="liveClock" style="color:var(--gold); font-size: 12px;"></div>
</div>

<section class="section" style="border: 1px solid var(--gold);">
    <h2>üì¢ Global Notification</h2>
    <div style="display:flex; gap:10px;">
        <input type="text" id="notifMsg" placeholder="Type message for all students...">
        <button class="btn btn-gold" style="width:120px;" onclick="sendNotif()">Send</button>
    </div>
</section>

<section class="section">
    <h2>üìç Today's Route & Skill (Manual)</h2>
    <div class="grid">
        <select id="updateBatchId"><option value="">Select Batch</option></select>
        <input type="text" id="dailyRoute" placeholder="Route Name">
        <input type="text" id="dailySkill" placeholder="Skill Name">
        <select id="showPlan">
            <option value="true">‚úÖ Show Plan (ON)</option>
            <option value="false">‚ùå Hide Plan (OFF)</option>
        </select>
        <button class="btn btn-gold" onclick="updateDailyPlan()">Update & Apply</button>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px;">
        <button class="btn btn-outline" onclick="manualBook()">‚ûï Manual Slot Booking</button>
    </div>
</section>

<section class="section">
    <h2>üéüÔ∏è Manage Batches</h2>
    <div class="grid">
        <input type="text" id="slotName" placeholder="Batch Name">
        <input type="text" id="slotTime" placeholder="Time (e.g. 7-8 AM)">
        <button class="btn btn-gold" onclick="addSlot()">Add Batch</button>
    </div>
    <div id="batchContainer" class="grid" style="margin-top:15px;"></div>
</section>

<section class="section">
    <h2>üöó Recent Bookings</h2>
    <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>Student</th><th>Batch</th><th>Seat</th><th>Action</th></tr></thead>
            <tbody id="bookingBody"></tbody>
        </table>
    </div>
</section>

<section class="section">
    <h2>üë®‚Äçüéì Registered Students</h2>
    <div class="grid">
        <input type="text" id="stuName" placeholder="Name">
        <input type="tel" id="stuPhone" placeholder="Phone">
        <input type="number" id="stuCount" placeholder="Classes Left">
        <button class="btn btn-gold" onclick="saveStudent()">Save Student</button>
    </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --- NOTIFICATION ---
  window.sendNotif = async () => {
    const text = document.getElementById("notifMsg").value;
    if(!text) return;
    await setDoc(doc(db, "siteControl", "notification"), { text, time: Date.now() });
    alert("Notification sent!");
    document.getElementById("notifMsg").value = "";
  };

  // --- DAILY PLAN ---
  window.updateDailyPlan = async () => {
    const id = document.getElementById("updateBatchId").value;
    const route = document.getElementById("dailyRoute").value;
    const skill = document.getElementById("dailySkill").value;
    const show = document.getElementById("showPlan").value === "true";
    if(!id) return alert("Select batch!");
    await updateDoc(doc(db, "siteSlots", id), { route, skill, showPlan: show });
    alert("Plan Updated!");
  };

  // --- MANUAL BOOKING ---
  window.manualBook = async () => {
    const id = document.getElementById("updateBatchId").value;
    if(!id) return alert("Select batch from dropdown first!");
    const seat = prompt("Seat Number (1-4)?");
    const name = prompt("Student Name?");
    if(!seat || !name) return;
    await setDoc(doc(db, "slotBookings", `${id}_${seat}`), {
        slotId: id, seat: parseInt(seat), name: name + " (Manual)", phone: "ADMIN", bookedAt: serverTimestamp()
    });
    alert("Booked!");
  };

  // --- BATCH MANAGER ---
  window.addSlot = async () => {
    const name = document.getElementById("slotName").value;
    const time = document.getElementById("slotTime").value;
    if(!name || !time) return;
    await setDoc(doc(db, "siteSlots", name), { name, time, route: "", skill: "", showPlan: false });
    alert("Batch Added!");
  };

  // --- REAL-TIME LISTENERS ---
  onSnapshot(collection(db, "siteSlots"), (snap) => {
    const cont = document.getElementById("batchContainer");
    const drop = document.getElementById("updateBatchId");
    cont.innerHTML = "";
    drop.innerHTML = '<option value="">Select Batch</option>';
    snap.forEach(d => {
        const s = d.data();
        drop.innerHTML += `<option value="${d.id}">${s.name}</option>`;
        cont.innerHTML += `<div class="batch-card">
            <b>${s.name}</b> <small>${s.time}</small><br>
            <span style="font-size:10px; color:${s.showPlan?'#00ff88':'#ff4d4d'}">${s.showPlan?'Plan: Live':'Plan: OFF'}</span>
            <button onclick="delBatch('${d.id}')" style="float:right; color:red; background:none; border:none; cursor:pointer;">Del</button>
        </div>`;
    });
  });

  onSnapshot(collection(db, "slotBookings"), (snap) => {
    const body = document.getElementById("bookingBody");
    body.innerHTML = "";
    snap.forEach(d => {
        const b = d.data();
        body.innerHTML += `<tr><td>${b.name}</td><td>${b.slotId}</td><td>A${b.seat}</td><td><button class="btn-danger" style="padding:2px 8px;" onclick="clearB('${d.id}')">Clear</button></td></tr>`;
    });
  });

  window.delBatch = async (id) => { if(confirm("Delete batch?")) await deleteDoc(doc(db, "siteSlots", id)); };
  window.clearB = async (id) => { if(confirm("Clear seat?")) await deleteDoc(doc(db, "slotBookings", id)); };
  
  window.saveStudent = async () => {
    const name = document.getElementById("stuName").value;
    const phone = document.getElementById("stuPhone").value;
    const count = document.getElementById("stuCount").value;
    await setDoc(doc(db, "studentData", phone), { name, phone, remaining: parseInt(count) });
    alert("Student Saved!");
  };

  setInterval(() => { document.getElementById("liveClock").innerText = new Date().toLocaleTimeString(); }, 1000);
</script>
</body>
</html>
