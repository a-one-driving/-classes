<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | A1 Driving</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #d4af37; 
            --gold-light: #f9e29d;
            --bg: #000; 
            --card-bg: #161616; 
            --input-bg: #080808;
            --success: #00ff88;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
        
        body { 
            background: var(--bg); 
            color: #fff; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            min-height: 100vh; 
        }

        .header-box { text-align: center; margin-bottom: 40px; }
        .header-box h1 { 
            font-size: 28px; 
            color: var(--gold); 
            font-weight: 800; 
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .header-box p { 
            font-size: 11px; 
            color: #666; 
            letter-spacing: 4px; 
            margin-top: 5px;
            text-transform: uppercase;
        }

        .main-container { 
            width: 100%; 
            max-width: 380px; 
            background: var(--card-bg); 
            padding: 35px 25px; 
            border-radius: 32px; 
            border: 1px solid #222; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            text-align: center;
        }

        .input-label { 
            display: block; 
            font-size: 12px; 
            color: #888; 
            margin-bottom: 15px; 
            font-weight: 600;
            letter-spacing: 1px;
        }

        input { 
            width: 100%; 
            padding: 18px; 
            border-radius: 18px; 
            border: 1px solid #333; 
            background: var(--input-bg); 
            color: #fff; 
            font-size: 17px; 
            margin-bottom: 25px; 
            outline: none; 
            text-align: center;
            letter-spacing: 1px;
        }

        .btn-gold { 
            background: linear-gradient(to bottom, #f9e29d, #d4af37); 
            color: #000; 
            border: none; 
            padding: 18px; 
            border-radius: 18px; 
            font-weight: 800; 
            cursor: pointer; 
            width: 100%; 
            font-size: 16px; 
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.2);
        }

        /* NEW: PREMIUM CERTIFICATE STYLES */
        #premiumCertificate {
            display: none;
            margin-bottom: 25px;
            padding: 2px;
            background: linear-gradient(45deg, #d4af37, #f9e29d, #aa841e, #d4af37);
            background-size: 400% 400%;
            animation: borderGlow 3s ease infinite;
            border-radius: 25px;
        }
        @keyframes borderGlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .cert-card-ui { background: rgba(10, 10, 10, 0.95); border-radius: 23px; padding: 25px; border: 1px solid rgba(255,255,255,0.05); }

        /* PROFILE CONTENT */
        #profileContent { display: none; width: 100%; animation: fadeIn 0.6s ease; }
        
        .student-name { font-size: 24px; font-weight: 800; margin-bottom: 5px; }
        .pkg-name { color: var(--gold); font-size: 13px; margin-bottom: 25px; font-weight: 600; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .stat-item { background: #000; padding: 15px; border-radius: 20px; border: 1px solid #222; }
        .stat-item span { font-size: 10px; color: #666; display: block; text-transform: uppercase; margin-bottom: 5px; }
        .stat-item b { font-size: 22px; color: #fff; }

        .progress-box { background: #000; padding: 20px; border-radius: 20px; border: 1px solid #222; margin-top: 10px; text-align: left; }
        .progress-bar { height: 8px; background: #222; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--gold); width: 0%; transition: 1.2s ease; }

        .timeline-box { background: #000; padding: 20px; border-radius: 20px; border: 1px solid #222; margin-top: 15px; text-align: left; }
        #attendanceTimeline { display: flex; flex-direction: column; gap: 10px; max-height: 200px; overflow-y: auto; margin-top: 10px; }
        .log-entry { 
            background: #111; padding: 10px 15px; border-radius: 12px; border-left: 3px solid var(--gold); 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .log-entry b { font-size: 13px; color: #fff; }
        .log-date { font-size: 10px; color: var(--gold); }

        .earn-banner { 
            background: rgba(0, 255, 136, 0.05); 
            border: 1px solid rgba(0, 255, 136, 0.1); 
            padding: 15px; border-radius: 20px; margin-top: 15px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .earn-banner span { font-size: 11px; color: var(--success); font-weight: 600; }
        .earn-banner b { font-size: 18px; color: #fff; }

        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn-action { 
            background: #000; border: 1px solid #333; color: #fff; padding: 14px; 
            border-radius: 16px; font-size: 12px; font-weight: 600; cursor: pointer; 
        }

        .logout-link { color: #444; font-size: 11px; margin-top: 25px; cursor: pointer; display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loader { display: none; margin: 10px auto; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; width: 25px; height: 25px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HIDDEN PDF TEMPLATE */
        #pdfTemplate { width: 800px; height: 600px; background: #000; color: #fff; padding: 40px; border: 15px solid #d4af37; display: none; position: absolute; left: -9999px; text-align: center; }
    </style>
</head>
<body>

    <div class="header-box">
        <h1>ABHINAASH A1</h1>
        <p>DRIVING ACADEMY</p>
    </div>

    <div class="main-container">
        <div id="searchPanel">
            <span class="input-label">ENTER REGISTERED NUMBER</span>
            <input type="tel" id="userPhone" placeholder="9933xxxxxx" maxlength="10">
            <button class="btn-gold" id="loadBtn" onclick="loadProfile()">Access Dashboard</button>
            <div id="loader"></div>
        </div>

        <div id="profileContent">
            <div id="premiumCertificate">
                <div class="cert-card-ui">
                    <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" style="width:50px; margin-bottom:10px;">
                    <h2 style="color:var(--gold); font-size:18px;">ELITE CERTIFIED</h2>
                    <p style="font-size:10px; color:#888; margin-bottom:15px;">Congratulations on completing your course!</p>
                    <button class="btn-gold" style="padding:10px; font-size:12px;" onclick="downloadPDF()">‚¨áÔ∏è DOWNLOAD PREMIUM PDF</button>
                </div>
            </div>

            <div class="student-name" id="dispName">Student Name</div>
            <div class="pkg-name" id="dispPkg">Driving Course</div>

            <div class="stats-row">
                <div class="stat-item"><span>Done</span><b id="dispDone">0</b></div>
                <div class="stat-item"><span>Target</span><b id="dispTotal">0</b></div>
            </div>

            <div class="progress-box">
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span style="color:#888;">LEARNING PROGRESS</span>
                    <span id="dispPercent" style="color:var(--gold);">0%</span>
                </div>
                <div class="progress-bar"><div class="progress-fill" id="dispBar"></div></div>
            </div>

            <div class="timeline-box">
                <span style="color:var(--gold); font-size: 10px; font-weight: 800; letter-spacing: 1px;">CLASS HISTORY</span>
                <div id="attendanceTimeline"></div>
            </div>

            <div class="earn-banner">
                <span>REFERRAL WALLET</span>
                <b id="dispEarn">‚Çπ0</b>
            </div>

            <div class="action-grid">
                <button class="btn-action" onclick="contactAdmin()">üí¨ HELP</button>
                <button class="btn-action" onclick="shareReferral()" style="color:var(--success); border-color:rgba(0,255,136,0.2);">üöÄ SHARE</button>
            </div>

            <a class="logout-link" onclick="location.reload()">‚Üê LOGOUT SESSION</a>
        </div>
    </div>

    <div id="pdfTemplate">
        <div style="border: 2px solid #d4af37; height: 100%; padding: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <img src="https://cdn-icons-png.flaticon.com/512/190/190411.png" style="width:80px;">
            <h1 style="color:#d4af37; font-size: 45px; margin: 15px 0;">ABHINAASH A1 DRIVING ACADEMY</h1>
            <p style="font-size: 18px; color: #888;">OFFICIAL CERTIFICATE OF EXCELLENCE</p>
            <p style="font-size: 16px; margin-top: 20px;">This is to certify that</p>
            <h2 id="pdfName" style="font-size: 40px; color: #fff; text-decoration: underline; margin: 10px 0;">NAME</h2>
            <p style="font-size: 16px; width: 80%; margin: 15px auto;">Has successfully completed the Advanced Driving Training with superior skill and dedication.</p>
            <div style="margin-top: 40px; border-top: 1px solid #555; width: 250px; padding-top:10px; font-size: 14px;">AUTHORIZED SIGNATURE</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
        authDomain: "abinash-driving.firebaseapp.com",
        projectId: "abinash-driving",
        storageBucket: "abinash-driving.appspot.com",
        messagingSenderId: "641148830173",
        appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentData = null;

    window.loadProfile = () => {
        const ph = document.getElementById('userPhone').value;
        if(ph.length < 10) return alert("Please enter 10 digit number.");

        document.getElementById('loadBtn').style.display = "none";
        document.getElementById('loader').style.display = "block";

        onSnapshot(doc(db, "studentData", ph), (snap) => {
            if(snap.exists()) {
                const data = snap.data();
                currentData = { ...data, phone: ph };
                
                const logs = data.attendanceLogs || [];
                
                // üî• SMART LOGIC: Recovering Geetika's 17/30 correctly
                const done = Math.max(logs.length, data.remaining || 0);
                
                const total = data.totalClasses || 15;
                const percent = Math.min(Math.round((done / total) * 100), 100);

                document.getElementById('dispName').innerText = data.name;
                document.getElementById('dispPkg').innerText = total + "-Day Training";
                document.getElementById('dispDone').innerText = done;
                document.getElementById('dispTotal').innerText = total;
                document.getElementById('dispPercent').innerText = percent + "%";
                document.getElementById('dispEarn').innerText = "‚Çπ" + (data.totalRefers * 500 || 0);
                
                // üî• CERTIFICATE UNLOCK
                if(done >= total) {
                    document.getElementById('premiumCertificate').style.display = 'block';
                    document.getElementById('pdfName').innerText = data.name.toUpperCase();
                }

                const timeline = document.getElementById('attendanceTimeline');
                timeline.innerHTML = "";
                [...logs].reverse().forEach((log, i) => {
                    const sessionNum = logs.length - i;
                    const displayTime = log.split(':')[0] + ":" + log.split(':')[1];
                    timeline.innerHTML += `
                        <div class="log-entry">
                            <b>Session ${sessionNum}</b>
                            <span class="log-date">${displayTime}</span>
                        </div>`;
                });

                document.getElementById('searchPanel').style.display = "none";
                document.getElementById('profileContent').style.display = "block";
                setTimeout(() => { document.getElementById('dispBar').style.width = percent + "%"; }, 100);
            } else {
                alert("No record found!");
                document.getElementById('loadBtn').style.display = "block";
                document.getElementById('loader').style.display = "none";
            }
        });
    }

    // PDF DOWNLOAD LOGIC
    window.downloadPDF = () => {
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        const opt = { margin: 0, filename: 'A1_Driving_Certificate.pdf', html2canvas: { scale: 2 }, jsPDF: { orientation: 'landscape' } };
        html2pdf().set(opt).from(element).save().then(() => element.style.display = 'none');
    };

    window.contactAdmin = () => {
        const msg = encodeURIComponent(`Hi Abhinaash, I am ${currentData.name}. I need help.`);
        window.location.href = `https://wa.me/917008186187?text=${msg}`;
    };

    window.shareReferral = () => {
        const text = encodeURIComponent(`Hey! join A1 Driving Academy. Use my referral.`);
        window.location.href = `https://wa.me/?text=${text}`;
    };
</script>
</body>
</html>
