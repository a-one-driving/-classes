<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Admin | Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #d4af37; --bg: #0b0b0b; --card: #1a1a1a; --txt: #ffffff; --danger: #ff4d4d; --success: #00ff88; }
    body { background: var(--bg); color: var(--txt); font-family: 'Poppins', sans-serif; padding: 15px; }
    .section { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 25px; }
    h2 { color: var(--gold); font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; outline: none; }
    button { background: var(--gold); color: #000; font-weight: 800; border: none; cursor: pointer; }
    
    /* Booking List Styling */
    .booking-card { background: #000; padding: 12px; border-radius: 10px; border-left: 4px solid var(--gold); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .booking-info b { color: var(--gold); display: block; font-size: 14px; }
    .booking-info span { font-size: 12px; color: #aaa; }
    .btn-del { background: var(--danger); color: white; width: auto; padding: 5px 12px; font-size: 11px; border: none; }
    
    /* Referral Specific */
    .ref-badge { background: rgba(0, 255, 136, 0.1); color: var(--success); padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: 800; display: inline-block; margin-top: 5px; border: 1px solid var(--success); }
    .btn-pay { background: var(--success); color: #000; width: auto; padding: 6px 12px; font-size: 11px; border-radius: 5px; border: none; font-weight: 800; }

    .batch-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; font-size: 13px; }
  </style>
</head>
<body>

<h1 style="font-size: 22px;">üëë A1 Control Panel</h1>
<p style="font-size: 11px; color: var(--gold); margin-bottom: 20px;">Abhinaash A1 Academy Management</p>

<div class="section" style="border-color: var(--success);">
  <h2 style="color: var(--success);">üí∏ AUTO-REFERRAL TRACKER (‚Çπ500)</h2>
  <div id="referralList">
    <p style="font-size: 12px; color: #555;">No referrals yet...</p>
  </div>
</div>

<div class="section" style="border-color: #00ff88;">
  <h2 style="color: #00ff88;">üì± LIVE BOOKINGS (Students)</h2>
  <div id="liveBookingList">
    <p style="font-size: 12px; color: #555;">No bookings yet...</p>
  </div>
</div>

<div class="section">
  <h2>üì¢ Notice Bar</h2>
  <input type="text" id="notifText" placeholder="Message (e.g. 10% Discount)">
  <select id="notifStatus">
    <option value="true">Show Now</option>
    <option value="false">Hide Bar</option>
  </select>
  <button onclick="updateNotif()">Save Notice</button>
</div>

<div class="section">
  <h2>üéüÔ∏è Manage Batches</h2>
  <input type="text" id="bId" placeholder="Batch ID (Unique)">
  <input type="text" id="bName" placeholder="Batch Name">
  <input type="text" id="bTime" placeholder="Time (e.g. 8AM-9AM)">
  <select id="bStatus">
    <option value="old">Regular</option>
    <option value="new">Mark as NEW</option>
  </select>
  <button onclick="addBatch()">Add Batch</button>
  <div id="batchList" style="margin-top: 15px;"></div>
</div>

<div class="section">
  <h2>üìä Student Classes</h2>
  <input type="tel" id="sPhone" placeholder="Mobile Number">
  <input type="text" id="sName" placeholder="Student Name">
  <input type="number" id="sRem" placeholder="Classes Remaining">
  <button onclick="updateStudent()">Update Balance</button>
</div>

<button style="background: #333; color: #888; margin-top: 20px;" onclick="clearAllBookings()">Clear All Bookings (Reset Week)</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 1. LIVE BOOKING & REFERRAL TRACKER
  onSnapshot(collection(db, "slotBookings"), (snap) => {
    const list = document.getElementById("liveBookingList");
    const refList = document.getElementById("referralList");
    
    list.innerHTML = "";
    refList.innerHTML = "";
    
    let refFound = false;

    snap.forEach(d => {
      const data = d.data();
      
      // Regular Booking UI
      list.innerHTML += `
        <div class="booking-card">
          <div class="booking-info">
            <b>${data.name}</b>
            <span>üìû ${data.phone} | Seat: ${d.id}</span>
          </div>
          <button class="btn-del" onclick="cancelBooking('${d.id}')">Cancel</button>
        </div>`;
      
      // Referral Tracker UI
      if(data.referredBy && data.referredBy !== "Direct Join") {
        refFound = true;
        refList.innerHTML += `
          <div class="booking-card" style="border-left-color: var(--success); background: #051a10;">
            <div class="booking-info">
              <b>${data.name} (Referred)</b>
              <span class="ref-badge">Referrer: ${data.referredBy}</span>
            </div>
            <button class="btn-pay" onclick="payRef('${data.referredBy}', '${data.name}')">WhatsApp Pay</button>
          </div>`;
      }
    });

    if(snap.empty) list.innerHTML = "<p style='color:#555; font-size:12px;'>No bookings.</p>";
    if(!refFound) refList.innerHTML = "<p style='color:#555; font-size:12px;'>No active referrals to pay.</p>";
  });

  window.payRef = (phone, student) => {
    const msg = `Hi! Your friend ${student} has joined A1 Academy. Please share your GPay/PhonePe number for your ‚Çπ500 Reward!`;
    window.open(`https://wa.me/91${phone}?text=${encodeURIComponent(msg)}`);
  };

  window.cancelBooking = async (id) => {
    if(confirm("Booking delete karein?")) await deleteDoc(doc(db, "slotBookings", id));
  };

  window.updateNotif = async () => {
    const txt = document.getElementById("notifText").value;
    const stat = document.getElementById("notifStatus").value === "true";
    await setDoc(doc(db, "siteSettings", "announcement"), { text: txt, active: stat });
    alert("Notice Updated!");
  };

  window.addBatch = async () => {
    const id = document.getElementById("bId").value;
    const name = document.getElementById("bName").value;
    const time = document.getElementById("bTime").value;
    const status = document.getElementById("bStatus").value;
    if(!id || !name) return alert("Fill data!");
    await setDoc(doc(db, "siteSlots", id), { name, time, status });
    alert("Batch Added!");
  };

  onSnapshot(collection(db, "siteSlots"), (snap) => {
    const list = document.getElementById("batchList");
    list.innerHTML = "<h3>Current Batches:</h3>";
    snap.forEach(d => {
      list.innerHTML += `
        <div class="batch-item">
          <span>${d.id} (${d.data().time})</span>
          <button class="btn-del" style="background:#222; border:none; width:30px;" onclick="deleteBatch('${d.id}')">X</button>
        </div>`;
    });
  });

  window.deleteBatch = async (id) => {
    if(confirm("Delete batch?")) await deleteDoc(doc(db, "siteSlots", id));
  };

  window.updateStudent = async () => {
    const p = document.getElementById("sPhone").value;
    const n = document.getElementById("sName").value;
    const r = document.getElementById("sRem").value;
    await setDoc(doc(db, "studentData", p), { name: n, remaining: r });
    alert("Student Updated!");
  };

  window.clearAllBookings = async () => {
    if(confirm("Reset all seats?")) {
      const snap = await getDocs(collection(db, "slotBookings"));
      snap.forEach(async (d) => await deleteDoc(doc(db, "slotBookings", d.id)));
      alert("All seats cleared!");
    }
  };
</script>
</body>
</html>
