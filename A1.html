<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Admin | Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #d4af37; --bg: #0b0b0b; --card: #1a1a1a; --txt: #ffffff; --danger: #ff4d4d; --success: #00ff88; }
    body { background: var(--bg); color: var(--txt); font-family: 'Poppins', sans-serif; padding: 15px; }
    .section { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 25px; }
    h2 { color: var(--gold); font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #333; background: #000; color: #fff; outline: none; }
    button { background: var(--gold); color: #000; font-weight: 800; border: none; cursor: pointer; }
    
    .booking-card { background: #000; padding: 12px; border-radius: 10px; border-left: 4px solid var(--gold); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .booking-info b { color: var(--gold); display: block; font-size: 14px; }
    .booking-info span { font-size: 12px; color: #aaa; }
    .btn-del { background: var(--danger); color: white; width: auto; padding: 5px 12px; font-size: 11px; border: none; }
    
    .batch-item { padding: 12px; border: 1px solid #333; border-radius: 10px; margin-bottom: 10px; background: #111; }
    .batch-info-text { font-size: 11px; color: #888; margin: 5px 0; }
    .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
    .badge-on { background: var(--success); color: #000; }
    .badge-off { background: #444; color: #fff; }

    .plan-box { background: #000; padding: 10px; border-radius: 8px; border: 1px dashed #444; margin-bottom: 10px; }
    .plan-box p { font-size: 11px; color: var(--gold); margin-bottom: 8px; }
  </style>
</head>
<body>

<h1 style="font-size: 22px;">üëë A1 Control Panel</h1>
<p style="font-size: 11px; color: var(--gold); margin-bottom: 20px;">Abhinaash A1 Academy Management</p>

<div class="section" style="border-color: var(--success);">
  <h2 style="color: var(--success);">üí∏ AUTO-REFERRAL TRACKER (‚Çπ500)</h2>
  <div id="referralList"></div>
</div>

<div class="section" style="border-color: #00ff88;">
  <h2 style="color: #00ff88;">üì± LIVE BOOKINGS (Students)</h2>
  <div id="liveBookingList"></div>
</div>

<div class="section">
  <h2>üéüÔ∏è Manage Batches (Route & Focus)</h2>
  <input type="text" id="bId" placeholder="Batch ID (e.g. eve_1)">
  <input type="text" id="bName" placeholder="Batch Name (e.g. Evening 1)">
  <input type="text" id="bTime" placeholder="Time Slot (e.g. 2-3 PM)">
  
  <div class="plan-box">
    <p>üìç Custom Plan Details (Website black box)</p>
    <input type="text" id="bRoute" placeholder="üìç Route: (e.g. Baghra Road route)">
    <input type="text" id="bSkill" placeholder="üéØ Focus: (e.g. Traffic challenges)">
    <select id="showPlan">
      <option value="true">Show Plan on Website</option>
      <option value="false">Hide Plan on Website</option>
    </select>
  </div>

  <select id="bStatus">
    <option value="old">Regular</option>
    <option value="new">Mark as NEW</option>
  </select>
  <button onclick="addBatch()">Add / Update Batch</button>
  <div id="batchList" style="margin-top: 15px;"></div>
</div>

<div class="section">
  <h2>üì¢ Notice Bar</h2>
  <input type="text" id="notifText" placeholder="Message">
  <select id="notifStatus">
    <option value="true">Show Now</option>
    <option value="false">Hide Bar</option>
  </select>
  <button onclick="updateNotif()">Save Notice</button>
</div>

<div class="section">
  <h2>üìä Student Classes</h2>
  <input type="tel" id="sPhone" placeholder="Mobile Number">
  <input type="text" id="sName" placeholder="Student Name">
  <input type="number" id="sRem" placeholder="Classes Remaining">
  <button onclick="updateStudent()">Update Balance</button>
</div>

<button style="background: #333; color: #888; margin-top: 20px;" onclick="clearAllBookings()">Clear All Bookings (Reset Week)</button>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 1. LIVE BOOKING & REFERRAL TRACKER
  onSnapshot(collection(db, "slotBookings"), (snap) => {
    const list = document.getElementById("liveBookingList");
    const refList = document.getElementById("referralList");
    list.innerHTML = ""; refList.innerHTML = "";
    let refFound = false;

    snap.forEach(d => {
      const data = d.data();
      list.innerHTML += `
        <div class="booking-card">
          <div class="booking-info"><b>${data.name}</b><span>üìû ${data.phone} | Seat: ${d.id}</span></div>
          <button class="btn-del" onclick="cancelBooking('${d.id}')">Cancel</button>
        </div>`;
      
      if(data.referredBy && data.referredBy !== "Direct Join") {
        refFound = true;
        refList.innerHTML += `
          <div class="booking-card" style="border-left-color: var(--success); background: #051a10;">
            <div class="booking-info"><b>${data.name} (Referred)</b><span class="ref-badge">Referrer: ${data.referredBy}</span></div>
            <button class="btn-pay" onclick="payRef('${data.referredBy}', '${data.name}')">WhatsApp Pay</button>
          </div>`;
      }
    });
  });

  // 2. MANAGE BATCHES (ADD/UPDATE)
  window.addBatch = async () => {
    const id = document.getElementById("bId").value;
    const name = document.getElementById("bName").value;
    const time = document.getElementById("bTime").value;
    const route = document.getElementById("bRoute").value;
    const skill = document.getElementById("bSkill").value;
    const showPlan = document.getElementById("showPlan").value === "true";
    const status = document.getElementById("bStatus").value;

    if(!id || !name) return alert("Fill Batch ID and Name!");

    await setDoc(doc(db, "siteSlots", id), { 
      name, time, status, 
      route: route || "Regular Route", 
      skill: skill || "General Skills",
      showPlan: showPlan 
    });
    alert("Batch Updated!");
    location.reload(); // Refresh to clear inputs
  };

  onSnapshot(collection(db, "siteSlots"), (snap) => {
    const list = document.getElementById("batchList");
    list.innerHTML = "<h3>Active Batches:</h3>";
    snap.forEach(d => {
      const data = d.data();
      list.innerHTML += `
        <div class="batch-item">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <b>${data.name} (${data.time}) <span class="status-badge ${data.showPlan ? 'badge-on' : 'badge-off'}">${data.showPlan ? 'PLAN ON' : 'PLAN OFF'}</span></b>
            <div>
               <button class="btn-del" style="background:#444; width:auto; margin-right:5px;" onclick="editBatch('${d.id}', '${data.name}', '${data.time}', '${data.route}', '${data.skill}', ${data.showPlan})">Edit</button>
               <button class="btn-del" style="width:30px;" onclick="deleteBatch('${d.id}')">X</button>
            </div>
          </div>
          <div class="batch-info-text">ID: ${d.id} | Route: ${data.route} | Focus: ${data.skill}</div>
        </div>`;
    });
  });

  window.editBatch = (id, name, time, route, skill, show) => {
    document.getElementById("bId").value = id;
    document.getElementById("bName").value = name;
    document.getElementById("bTime").value = time;
    document.getElementById("bRoute").value = route;
    document.getElementById("bSkill").value = skill;
    document.getElementById("showPlan").value = show.toString();
    window.scrollTo(0,0);
  };

  window.deleteBatch = async (id) => { if(confirm("Delete batch?")) await deleteDoc(doc(db, "siteSlots", id)); };
  window.updateNotif = async () => { /* Logic same as before */ };
  window.updateStudent = async () => { /* Logic same as before */ };
  window.clearAllBookings = async () => { /* Logic same as before */ };
</script>
</body>
</html>
