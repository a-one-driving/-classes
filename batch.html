<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Admin | Master Control</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;900&display=swap" rel="stylesheet">
  <style>
    :root { 
      --gold: #d4af37; 
      --bg: #000000; 
      --card: #121212; 
      --border: #2a2a2a;
      --txt: #ffffff; 
      --danger: #ff4d4d; 
      --success: #2ecc71;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    
    body { 
      background: var(--bg); 
      color: var(--txt); 
      padding: 15px;
      line-height: 1.6;
    }

    .container { max-width: 1000px; margin: auto; }

    header { text-align: center; padding: 20px 0 30px; }
    header h1 { color: var(--gold); font-weight: 900; letter-spacing: 2px; font-size: 24px; text-transform: uppercase; }
    header p { color: #666; font-size: 12px; }

    /* Setup Panel */
    .panel-card { 
      background: var(--card); 
      border: 1px solid var(--border); 
      padding: 20px; 
      border-radius: 20px; 
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .setup-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr auto; 
      gap: 12px; 
      align-items: center;
    }

    @media (max-width: 600px) {
      .setup-grid { grid-template-columns: 1fr; }
      .btn-create { width: 100% !important; }
    }

    input, select { 
      width: 100%; 
      padding: 12px 15px; 
      background: #080808; 
      border: 1px solid var(--border); 
      color: #fff; 
      border-radius: 10px; 
      outline: none; 
      font-size: 14px;
      transition: 0.3s;
    }

    input:focus, select:focus { border-color: var(--gold); background: #111; }

    .btn { 
      background: var(--gold); 
      color: #000; 
      border: none; 
      padding: 12px 25px; 
      border-radius: 10px; 
      font-weight: 700; 
      cursor: pointer; 
      transition: 0.3s;
      text-transform: uppercase;
      font-size: 13px;
    }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }

    /* Batch Grid */
    #editorZone { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 20px; 
    }

    .batch-list-item { 
      background: var(--card); 
      border: 1px solid var(--border); 
      padding: 20px; 
      border-radius: 20px; 
      display: flex;
      flex-direction: column;
      transition: 0.3s;
    }

    .batch-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start; 
      margin-bottom: 20px;
    }

    .batch-header b { font-size: 18px; color: var(--gold); display: block; }
    .batch-header small { color: #888; font-weight: 400; }

    .btn-delete-batch { 
      color: var(--danger); 
      font-size: 11px; 
      cursor: pointer; 
      background: rgba(255,77,77,0.1);
      padding: 5px 10px;
      border-radius: 6px;
      border: none;
    }

    /* Student Rows */
    .student-list { flex-grow: 1; }
    .student-row { 
      background: #080808; 
      padding: 12px; 
      border-radius: 12px; 
      margin-bottom: 10px; 
      border: 1px solid #1a1a1a;
    }

    .student-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .student-name { font-weight: 600; font-size: 14px; }
    
    .days-input-wrap { display: flex; align-items: center; gap: 8px; font-size: 12px; color: #888; }
    .days-input { width: 45px !important; padding: 4px !important; text-align: center; margin: 0 !important; border-color: #333 !important; }

    .progress-bar { width: 100%; height: 5px; background: #222; border-radius: 10px; margin: 8px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--gold); border-radius: 10px; box-shadow: 0 0 10px rgba(212,175,55,0.3); }

    .student-footer { display: flex; justify-content: space-between; align-items: center; }
    .percentage-text { font-size: 10px; color: #555; font-weight: 600; }
    .btn-del-user { color: var(--danger); background: none; border: none; font-size: 18px; cursor: pointer; line-height: 1; }

    .add-student-box { 
      margin-top: 20px; 
      padding-top: 15px; 
      border-top: 1px dashed #333; 
      display: flex; 
      gap: 10px; 
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>A1 Master Control</h1>
    <p>Live Batch & Student Management</p>
  </header>

  <div class="panel-card">
    <h3 style="color:var(--gold); margin-bottom:15px; font-size: 14px; text-transform: uppercase;">+ New Batch Configuration</h3>
    <div class="setup-grid">
      <input type="text" id="newBatchName" placeholder="Batch Name (e.g. Morning A)">
      <input type="text" id="newBatchTime" placeholder="Time (e.g. 7:00 - 8:00 AM)">
      <button class="btn btn-create" onclick="createNewBatch()">Create</button>
    </div>
  </div>

  <div id="editorZone">
    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #444;">
        Fetching encrypted data from A1 Database...
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let studentDataMap = [];
  let allBatches = [];

  async function syncAttendanceData() {
    const snap = await getDocs(collection(db, "studentData"));
    studentDataMap = [];
    snap.forEach(d => {
      studentDataMap.push({ id: d.id, ...d.data() });
    });
    renderUI();
  }

  onSnapshot(collection(db, "activeBatches"), (snap) => {
    allBatches = [];
    snap.forEach(d => allBatches.push({ id: d.id, ...d.data() }));
    syncAttendanceData();
  });

  function renderUI() {
    const zone = document.getElementById('editorZone');
    zone.innerHTML = "";

    allBatches.forEach(batch => {
      let studentRows = "";
      batch.students.forEach((s, index) => {
        const progress = Math.round(((15 - s.daysLeft) / 15) * 100);
        studentRows += `
          <div class="student-row">
            <div class="student-info">
                <span class="student-name">${s.name}</span>
                <div class="days-input-wrap">
                    Left: <input type="number" class="days-input" value="${s.daysLeft}" onchange="updateClassCount('${batch.id}', ${index}, this.value)">
                </div>
            </div>
            <div class="progress-bar"><div class="progress-fill" style="width:${progress > 0 ? (progress > 100 ? 100 : progress) : 0}%"></div></div>
            <div class="student-footer">
                <span class="percentage-text">${progress > 0 ? progress : 0}% COMPLETED</span>
                <button class="btn-del-user" onclick="removeStudent('${batch.id}', ${index})">&times;</button>
            </div>
          </div>`;
      });

      const options = studentDataMap.map(st => `<option value="${st.name}">${st.name}</option>`).join('');

      zone.innerHTML += `
        <div class="batch-list-item">
          <div class="batch-header">
            <div>
                <b>${batch.batchName}</b>
                <small>${batch.time}</small>
            </div>
            <button class="btn-delete-batch" onclick="deleteBatch('${batch.id}')">Delete Batch</button>
          </div>
          <div class="student-list">
            ${studentRows || '<p style="text-align:center; padding:20px; font-size:12px; color:#333;">No students assigned.</p>'}
          </div>
          <div class="add-student-box">
            <select id="sel_${batch.id}">
                <option value="">Select Student</option>
                ${options}
            </select>
            <button class="btn" style="padding:10px 15px;" onclick="addStudentToBatch('${batch.id}')">ADD</button>
          </div>
        </div>`;
    });
  }

  // --- ACTIONS (Original Logic Maintained) ---

  window.createNewBatch = async () => {
    const name = document.getElementById('newBatchName').value;
    const time = document.getElementById('newBatchTime').value;
    if(!name || !time) return alert("Please enter Batch Name and Time!");
    await setDoc(doc(db, "activeBatches", "batch_" + Date.now()), { batchName: name, time: time, students: [] });
    document.getElementById('newBatchName').value = "";
    document.getElementById('newBatchTime').value = "";
  };

  window.addStudentToBatch = async (batchId) => {
    const name = document.getElementById(`sel_${batchId}`).value;
    if(!name) return alert("Pehle student select karein!");
    
    const studentInfo = studentDataMap.find(st => st.name === name);
    const total = studentInfo.totalClasses || 15;
    const done = studentInfo.remaining || 0;
    const autoDaysLeft = total - done;

    const batch = allBatches.find(b => b.id === batchId);
    
    // Check if student already exists in this batch
    if(batch.students.find(s => s.name === name)) return alert("Student already in this batch!");

    const newStudents = [...batch.students, { 
        name: name, 
        daysLeft: autoDaysLeft > 0 ? autoDaysLeft : 0 
    }];
    
    await updateDoc(doc(db, "activeBatches", batchId), { students: newStudents });
  };

  window.updateClassCount = async (batchId, index, newVal) => {
    const batch = allBatches.find(b => b.id === batchId);
    batch.students[index].daysLeft = parseInt(newVal);
    await updateDoc(doc(db, "activeBatches", batchId), { students: batch.students });
  };

  window.removeStudent = async (batchId, index) => {
    if(!confirm("Remove student from this batch?")) return;
    const batch = allBatches.find(b => b.id === batchId);
    batch.students.splice(index, 1);
    await updateDoc(doc(db, "activeBatches", batchId), { students: batch.students });
  };

  window.deleteBatch = async (id) => {
    if(confirm("Are you sure? This will delete the entire batch.")) await deleteDoc(doc(db, "activeBatches", id));
  };

</script>
</body>
</html>
