<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A1 Attendance | Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --gold: #d4af37; --bg: #000; --card: #111; --success: #00ff88; --danger: #ff4d4d; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', sans-serif; }
    body { background: var(--bg); color: #fff; padding: 15px; padding-bottom: 100px; }
    .header { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(15px); padding: 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #222; margin: -15px -15px 20px -15px; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 18px; color: var(--gold); letter-spacing: 1px; }
    .search-bar { width: 100%; background: #121212; border: 1px solid #222; padding: 15px; border-radius: 15px; color: #fff; outline: none; margin-bottom: 20px; }
    .attendance-grid { display: grid; gap: 12px; }
    .st-card { background: var(--card); border-radius: 20px; padding: 15px; border: 1px solid #222; display: flex; align-items: center; position: relative; }
    .st-initial { width: 45px; height: 45px; background: #1a1a1a; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: var(--gold); border: 1px solid #333; margin-right: 12px; }
    .st-details { flex: 1; }
    .st-details b { font-size: 15px; display: block; text-transform: capitalize; }
    .st-details span { font-size: 11px; color: #555; }
    .progress-mini { width: 60px; text-align: right; margin-right: 10px; }
    .mark-btn { background: var(--gold); color: #000; border: none; width: 42px; height: 42px; border-radius: 12px; font-size: 20px; font-weight: bold; cursor: pointer; }
    .fab { position: fixed; bottom: 85px; right: 20px; width: 55px; height: 55px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; color: #000; z-index: 999; cursor: pointer; border: none; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
    .modal-content { background: #111; padding: 25px; border-radius: 25px; border: 1px solid #222; width: 100%; max-width: 400px; }
    input { width: 100%; padding: 15px; margin-bottom: 15px; background: #000; border: 1px solid #333; border-radius: 12px; color: #fff; }
    .save-btn { width: 100%; padding: 15px; background: var(--gold); border: none; border-radius: 12px; font-weight: 800; cursor: pointer; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #000; border-top: 1px solid #222; padding: 15px; display: flex; justify-content: space-around; }
    .status-done { border-color: var(--success) !important; opacity: 0.6; }
  </style>
</head>
<body>

<div class="header">
    <h1>A1 ATTENDANCE</h1>
    <p id="dateDisplay" style="font-size: 10px; color: #666;"></p>
</div>

<input type="text" id="studentSearch" class="search-bar" placeholder="ðŸ” Search student name..." onkeyup="filterList()">
<div id="attendanceList" class="attendance-grid"></div>

<button class="fab" onclick="toggleModal(true)">+</button>

<div id="addModal" class="modal">
    <div class="modal-content">
        <h2>Add New Student</h2>
        <input type="tel" id="newPhone" placeholder="Phone Number">
        <input type="text" id="newName" placeholder="Full Name">
        <input type="number" id="newTotal" placeholder="Total Classes" value="15">
        <button class="save-btn" onclick="addNewStudent()">SAVE STUDENT</button>
        <button onclick="toggleModal(false)" style="background:none; border:none; color:#666; width:100%; margin-top:15px;">Close</button>
    </div>
</div>

<div class="bottom-nav">
    <div style="text-align:center"><b id="totalActive" style="color:var(--gold)">0</b><br><small style="font-size:9px">ACTIVE</small></div>
    <div style="text-align:center"><b id="totalFinished" style="color:var(--gold)">0</b><br><small style="font-size:9px">FINISHED</small></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getFirestore, collection, onSnapshot, doc, setDoc, updateDoc, deleteDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC3gWi8p85z-wkoJeWbN3jYoQpcIar8Sww",
    authDomain: "abinash-driving.firebaseapp.com",
    projectId: "abinash-driving",
    storageBucket: "abinash-driving.appspot.com",
    messagingSenderId: "641148830173",
    appId: "1:641148830173:web:b7a500e5e7e2463da0f634"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  onSnapshot(collection(db, "studentData"), (snap) => {
    const list = document.getElementById("attendanceList");
    list.innerHTML = "";
    let active = 0, finished = 0;
    snap.forEach(d => {
      const data = d.data();
      
      const logCount = (data.attendanceLogs) ? data.attendanceLogs.length : 0;
      const done = Math.max(logCount, data.remaining || 0);
      
      const total = data.totalClasses || 15;
      const isDone = done >= total;
      if(isDone) finished++; else active++;

      list.innerHTML += `
        <div class="st-card ${isDone ? 'status-done' : ''}" data-name="${data.name.toLowerCase()}">
          <div class="st-initial">${data.name.charAt(0)}</div>
          <div class="st-details"><b>${data.name}</b><span>ðŸ“ž ${d.id}</span></div>
          <div class="progress-mini"><b>${done}/${total}</b><p style="font-size:8px">DONE</p></div>
          <button class="mark-btn" onclick="markPresent('${d.id}')" ${isDone ? 'disabled' : ''}>+</button>
          <button style="background:none; border:none; color:#333; margin-left:10px; font-size:18px;" onclick="removeStudent('${d.id}')">Ã—</button>
        </div>`;
    });
    document.getElementById('totalActive').innerText = active;
    document.getElementById('totalFinished').innerText = finished;
  });

  window.markPresent = async (id) => { 
    // ðŸ”¥ FEEDBACK LOGIC ADDED
    const remark = prompt("Aaj ki galti ya improvement likhein:");
    if (remark === null) return; // Cancel handle

    const now = new Date();
    const stamp = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) + " | " + 
                  now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    // Yahan hum stamp aur remark ko " â€” " se join kar rahe hain
    const entry = `${stamp} â€” ${remark || "Session completed"}`;

    await updateDoc(doc(db, "studentData", id), { 
        remaining: increment(1),
        attendanceLogs: arrayUnion(entry) 
    }); 
  };

  window.addNewStudent = async () => {
    const p = document.getElementById('newPhone').value;
    const n = document.getElementById('newName').value;
    const t = document.getElementById('newTotal').value;
    if(!p || !n) return alert("Fill Name and Phone");
    await setDoc(doc(db, "studentData", p), { name: n, remaining: 0, totalClasses: parseInt(t), attendanceLogs: [] });
    toggleModal(false);
  };

  window.removeStudent = async (id) => { if(confirm("Delete student?")) await deleteDoc(doc(db, "studentData", id)); };
  window.toggleModal = (show) => document.getElementById('addModal').style.display = show ? 'flex' : 'none';
  window.filterList = () => {
    const val = document.getElementById("studentSearch").value.toLowerCase();
    document.querySelectorAll('.st-card').forEach(c => {
        c.style.display = c.getAttribute('data-name').includes(val) ? "flex" : "none";
    });
  };
</script>
</body>
</html>
